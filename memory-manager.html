<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Memoria di Aiko</title>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background-color: #2a2a2a;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .header h1 {
            margin: 0;
            color: #fff;
            font-size: 24px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }
        
        .tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 2px solid #3a3a3a;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            color: #aaa;
        }
        
        .tab.active {
            color: #fff;
            border-bottom-color: #4a9eff;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .memory-card {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            position: relative;
            transition: all 0.3s;
        }
        
        .memory-card:hover {
            background-color: #333;
        }
        
        .memory-type {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .type-famiglia { background-color: #4a90e2; }
        .type-persona { background-color: #f39c12; }
        .type-data { background-color: #e74c3c; }
        .type-luogo { background-color: #2ecc71; }
        .type-preferenza { background-color: #9b59b6; }
        .type-progetto { background-color: #1abc9c; }
        .type-altro { background-color: #95a5a6; }
        
        .memory-info {
            font-size: 16px;
            margin-bottom: 8px;
        }
        
        .memory-context {
            font-size: 14px;
            color: #aaa;
            font-style: italic;
        }
        
        .memory-confidence {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 12px;
            color: #888;
        }
        
        .confidence-alta { color: #2ecc71; }
        .confidence-media { color: #f39c12; }
        .confidence-bassa { color: #e74c3c; }
        
        .memory-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-edit {
            background-color: #3498db;
            color: white;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            color: white;
        }
        
        .btn-primary {
            background-color: #4a9eff;
            color: white;
            padding: 12px 24px;
            font-size: 16px;
        }
        
        .btn:hover {
            opacity: 0.8;
        }
        
        .profile-section {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .profile-section h3 {
            margin-top: 0;
            color: #4a9eff;
        }
        
        .profile-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #3a3a3a;
        }
        
        .profile-item:last-child {
            border-bottom: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #888;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #888;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #4a9eff;
        }
        
        .stat-label {
            color: #888;
            margin-top: 5px;
        }
        
        #editModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        #editModal.show {
            display: flex;
        }
        
        .modal-content {
            background-color: #2a2a2a;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
        }
        
        .modal-content h2 {
            margin-top: 0;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #ccc;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #3a3a3a;
            border-radius: 6px;
            background-color: #1a1a1a;
            color: #e0e0e0;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ§  Gestione Memoria di Aiko</h1>
    </div>
    
    <div class="container">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('memories')">Memorie</div>
            <div class="tab" onclick="switchTab('profile')">Profilo Utente</div>
            <div class="tab" onclick="switchTab('sessions')">Sessioni</div>
            <div class="tab" onclick="switchTab('settings')">Impostazioni</div>
        </div>
        
        <!-- Tab Memorie -->
        <div id="memories-tab" class="tab-content active">
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalMemories">0</div>
                    <div class="stat-label">Memorie Totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="recentConversations">0</div>
                    <div class="stat-label">Conversazioni Recenti</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="topicsCount">0</div>
                    <div class="stat-label">Argomenti Trattati</div>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="addNewMemory()">+ Aggiungi Memoria</button>
            
            <div id="memoriesList" class="loading">
                Caricamento memorie...
            </div>
        </div>
        
        <!-- Tab Profilo -->
        <div id="profile-tab" class="tab-content">
            <button class="btn btn-primary" onclick="updateProfile()">Aggiorna Profilo</button>
            
            <div id="profileContent" class="loading">
                Caricamento profilo...
            </div>
        </div>
        
        <!-- Tab Sessioni -->
        <div id="sessions-tab" class="tab-content">
            <div id="sessionsList" class="loading">
                Caricamento sessioni...
            </div>
        </div>
        
        <!-- Tab Impostazioni -->
        <div id="settings-tab" class="tab-content">
            <div class="profile-section">
                <h3>Preferenze Privacy</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="rememberConversations" checked>
                        Ricorda le conversazioni
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="rememberPersonalInfo" checked>
                        Ricorda informazioni personali
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="autoExtractInfo" checked>
                        Estrai automaticamente informazioni importanti
                    </label>
                </div>
                <div class="form-group">
                    <label>
                        Giorni di retention:
                        <input type="number" id="retentionDays" value="90" min="1" max="365">
                    </label>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()">Salva Impostazioni</button>
                <button class="btn btn-delete" onclick="clearAllMemories()">Cancella Tutte le Memorie</button>
            </div>
        </div>
    </div>
    
    <!-- Modal per modifica memoria -->
    <div id="editModal">
        <div class="modal-content">
            <h2 id="modalTitle">Modifica Memoria</h2>
            <form id="editForm">
                <input type="hidden" id="memoryId">
                <div class="form-group">
                    <label for="memoryType">Tipo:</label>
                    <select id="memoryType">
                        <option value="famiglia">Famiglia</option>
                        <option value="persona">Persona</option>
                        <option value="data">Data</option>
                        <option value="luogo">Luogo</option>
                        <option value="preferenza">Preferenza</option>
                        <option value="progetto">Progetto</option>
                        <option value="altro">Altro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="memoryInfo">Informazione:</label>
                    <textarea id="memoryInfo" required></textarea>
                </div>
                <div class="form-group">
                    <label for="memoryContext">Contesto:</label>
                    <input type="text" id="memoryContext">
                </div>
                <div class="form-group">
                    <label for="memoryConfidence">Confidenza:</label>
                    <select id="memoryConfidence">
                        <option value="alta">Alta</option>
                        <option value="media">Media</option>
                        <option value="bassa">Bassa</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn" onclick="closeModal()">Annulla</button>
                    <button type="submit" class="btn btn-primary">Salva</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Funzione per escape HTML e prevenire XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Gestione tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Carica i dati del tab
            switch(tabName) {
                case 'memories':
                    loadMemories();
                    break;
                case 'profile':
                    loadProfile();
                    break;
                case 'sessions':
                    loadSessions();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
        }
        
        // Carica memorie
        async function loadMemories() {
            try {
                const response = await fetch('/api/manageMemory');
                const data = await response.json();
                
                document.getElementById('totalMemories').textContent = data.total_memories;
                document.getElementById('recentConversations').textContent = data.recent_conversations?.length || 0;
                
                const memoriesList = document.getElementById('memoriesList');
                
                if (data.memories.length === 0) {
                    memoriesList.innerHTML = '<div class="empty-state">Nessuna memoria salvata ancora.</div>';
                    return;
                }
                
                memoriesList.innerHTML = data.memories.map(memory => `
                    <div class="memory-card">
                        <span class="memory-type type-${escapeHtml(memory.type)}">${escapeHtml(memory.type)}</span>
                        <span class="memory-confidence confidence-${escapeHtml(memory.confidence)}">${escapeHtml(memory.confidence)}</span>
                        <div class="memory-info">${escapeHtml(memory.info)}</div>
                        ${memory.context ? `<div class="memory-context">${escapeHtml(memory.context)}</div>` : ''}
                        <div class="memory-actions">
                            <button class="btn btn-edit" onclick="editMemory('${memory.id}')">Modifica</button>
                            <button class="btn btn-delete" onclick="deleteMemory('${memory.id}')">Elimina</button>
                        </div>
                    </div>
                `).join('');
                
                // Conta argomenti unici
                const topics = new Set();
                data.memories.forEach(m => {
                    if (m.type === 'progetto' || m.type === 'preferenza') {
                        topics.add(m.info.split(' ')[0]);
                    }
                });
                document.getElementById('topicsCount').textContent = topics.size;
                
            } catch (error) {
                console.error('Errore caricamento memorie:', error);
                document.getElementById('memoriesList').innerHTML = 
                    '<div class="empty-state">Errore nel caricamento delle memorie.</div>';
            }
        }
        
        // Carica profilo
        async function loadProfile() {
            try {
                const response = await fetch('/api/userProfile');
                const data = await response.json();
                
                const profileContent = document.getElementById('profileContent');
                
                if (!data.profile) {
                    profileContent.innerHTML = '<div class="empty-state">Nessun profilo generato ancora.</div>';
                    return;
                }
                
                const profile = data.profile;
                let html = '';
                
                // Preferenze di risposta
                if (profile.response_preferences?.length > 0) {
                    html += '<div class="profile-section"><h3>Preferenze di Risposta</h3>';
                    profile.response_preferences.forEach(pref => {
                        html += `<div class="profile-item">
                            <strong>${escapeHtml(pref.preference)}</strong> 
                            <span class="confidence-${escapeHtml(pref.confidence)}">(${escapeHtml(pref.confidence)})</span>
                        </div>`;
                    });
                    html += '</div>';
                }
                
                // Stile comunicativo
                if (profile.communication_style) {
                    html += '<div class="profile-section"><h3>Stile Comunicativo</h3>';
                    html += `<div class="profile-item">
                        FormalitÃ : ${escapeHtml(profile.communication_style.formality)}<br>
                        Umorismo: ${escapeHtml(profile.communication_style.humor)}<br>
                        Livello tecnico: ${escapeHtml(profile.communication_style.technical_level)}
                    </div>`;
                    html += '</div>';
                }
                
                // Interessi
                if (profile.interests?.length > 0) {
                    html += '<div class="profile-section"><h3>Interessi</h3>';
                    html += `<div class="profile-item">${profile.interests.join(', ')}</div>`;
                    html += '</div>';
                }
                
                profileContent.innerHTML = html;
                
            } catch (error) {
                console.error('Errore caricamento profilo:', error);
                document.getElementById('profileContent').innerHTML = 
                    '<div class="empty-state">Errore nel caricamento del profilo.</div>';
            }
        }
        
        // Carica sessioni
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessionMetadata');
                const data = await response.json();
                
                const sessionsList = document.getElementById('sessionsList');
                
                if (data.sessions.length === 0) {
                    sessionsList.innerHTML = '<div class="empty-state">Nessuna sessione registrata.</div>';
                    return;
                }
                
                sessionsList.innerHTML = data.sessions.map(session => {
                    const start = new Date(session.session_start);
                    const end = session.session_end ? new Date(session.session_end) : null;
                    const duration = end ? Math.round((end - start) / 60000) : 0;
                    
                    return `
                        <div class="memory-card">
                            <h4>${escapeHtml(start.toLocaleString('it-IT'))}</h4>
                            <div>Messaggi: ${escapeHtml(session.messages_count.toString())}</div>
                            <div>Durata: ${escapeHtml(duration.toString())} minuti</div>
                            <div>Sentiment: <span class="confidence-${
                                session.sentiment === 'positivo' ? 'alta' : 
                                session.sentiment === 'negativo' ? 'bassa' : 'media'
                            }">${escapeHtml(session.sentiment)}</span></div>
                            ${session.topics?.length > 0 ? 
                                `<div>Argomenti: ${escapeHtml(session.topics.slice(0, 5).join(', '))}</div>` : ''}
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Errore caricamento sessioni:', error);
                document.getElementById('sessionsList').innerHTML = 
                    '<div class="empty-state">Errore nel caricamento delle sessioni.</div>';
            }
        }
        
        // Gestione modal
        function addNewMemory() {
            document.getElementById('modalTitle').textContent = 'Aggiungi Nuova Memoria';
            document.getElementById('editForm').reset();
            document.getElementById('memoryId').value = '';
            document.getElementById('editModal').classList.add('show');
        }
        
        async function editMemory(id) {
            // Qui andrebbe caricata la memoria specifica
            // Per ora riempiamo con dati di esempio
            document.getElementById('modalTitle').textContent = 'Modifica Memoria';
            document.getElementById('memoryId').value = id;
            document.getElementById('editModal').classList.add('show');
        }
        
        function closeModal() {
            document.getElementById('editModal').classList.remove('show');
        }
        
        // Gestione form
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const memoryData = {
                id: document.getElementById('memoryId').value || undefined,
                type: document.getElementById('memoryType').value,
                info: document.getElementById('memoryInfo').value,
                context: document.getElementById('memoryContext').value,
                confidence: document.getElementById('memoryConfidence').value
            };
            
            try {
                const response = await fetch('/api/manageMemory', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(memoryData)
                });
                
                if (response.ok) {
                    closeModal();
                    loadMemories();
                } else {
                    alert('Errore nel salvataggio della memoria');
                }
            } catch (error) {
                console.error('Errore:', error);
                alert('Errore nel salvataggio della memoria');
            }
        });
        
        // Elimina memoria
        async function deleteMemory(id) {
            if (!confirm('Sei sicuro di voler eliminare questa memoria?')) return;
            
            try {
                const response = await fetch('/api/manageMemory', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ memoryId: id })
                });
                
                if (response.ok) {
                    loadMemories();
                }
            } catch (error) {
                console.error('Errore eliminazione:', error);
            }
        }
        
        // Aggiorna profilo
        async function updateProfile() {
            if (!confirm('Vuoi aggiornare il profilo analizzando le conversazioni recenti?')) return;
            
            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'Aggiornamento in corso...';
                
                const response = await fetch('/api/userProfile', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadProfile();
                    alert('Profilo aggiornato con successo!');
                }
            } catch (error) {
                console.error('Errore aggiornamento profilo:', error);
                alert('Errore nell\'aggiornamento del profilo');
            } finally {
                const btn = event.target;
                btn.disabled = false;
                btn.textContent = 'Aggiorna Profilo';
            }
        }
        
        // Cancella tutte le memorie
        async function clearAllMemories() {
            if (!confirm('Sei sicuro di voler cancellare TUTTE le memorie? Questa azione Ã¨ irreversibile!')) return;
            
            try {
                const response = await fetch('/api/manageMemory', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ deleteAll: true })
                });
                
                if (response.ok) {
                    alert('Tutte le memorie sono state cancellate.');
                    loadMemories();
                }
            } catch (error) {
                console.error('Errore cancellazione:', error);
            }
        }
        
        // Carica impostazioni
        function loadSettings() {
            // Le impostazioni andrebbero caricate dal server
            // Per ora usiamo valori di default
        }
        
        // Salva impostazioni
        async function saveSettings() {
            // Qui andrebbe implementato il salvataggio delle impostazioni
            alert('Impostazioni salvate!');
        }
        
        // Carica le memorie all'avvio
        loadMemories();
    </script>
</body>
</html> 